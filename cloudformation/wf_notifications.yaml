AWSTemplateFormatVersion: "2010-09-09"

Parameters:
  WorkflowName:
    Type: String

  HandlerLambdaArn:
    Type: String

  JobStatusLambdaArn:
    Type: String

  StateMachineArn:
    Type: String

Resources:
  wfOutputSNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "${WorkflowName}-notifications"
      KmsMasterKeyId: "alias/aws/sns"

  wfOutputSNSTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref wfOutputSNSTopic
      PolicyDocument:
        Version: "2012-10-17"
        Id: "wfOutputSNSTopicPolicy"
        Statement:
          -
            Sid: OwnerAccessOnly
            Effect: Allow
            Principal:
              AWS: "*"
            Action:
              - "SNS:AddPermission"
              - "SNS:DeleteTopic"
              - "SNS:GetTopicAttributes"
              - "SNS:ListSubscriptionsByTopic"
              - "SNS:Publish"
              - "SNS:Receive"
              - "SNS:RemovePermission"
              - "SNS:SetTopicAttributes"
              - "SNS:Subscribe"
            Resource: !Ref wfOutputSNSTopic
            Condition:
              StringEquals:
                "AWS:SourceOwner": !Ref AWS::AccountId
          -
            Sid: SecureTransport
            Effect: Deny
            Principal: "*"
            Action: "sns:Publish"
            Resource: !Ref wfOutputSNSTopic
            Condition:
              Bool:
                "aws:SecureTransport": "false"

  wfSFNtoLambdaRule:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.states
        detail-type:
          - Step Functions Execution Status Change
        detail:
          stateMachineArn:
            - !Ref StateMachineArn
      State: ENABLED
      Targets:
        -
          Arn: !Ref HandlerLambdaArn
          Id: HandlerLambdaTargetId
          InputTransformer:
            InputPathsMap:
              detail: "$.detail"
            InputTemplate:
              !Sub |-
                {
                  "workflow_name": "${WorkflowName}",
                  "sns_topic_arn": "${wfOutputSNSTopic}",
                  "event": <aws.events.event>,
                  "detail": <detail>
                }

  wfJobStatusSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !Ref JobStatusLambdaArn
      Protocol: lambda
      TopicArn: !Ref wfOutputSNSTopic

Outputs:
  wfOutputTopicArn:
    Value: !Ref wfOutputSNSTopic
